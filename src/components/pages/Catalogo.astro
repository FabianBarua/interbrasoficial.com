---
import { getValueFromKey, getI18NCatalog } from "@/i18n";
import { cn } from "@/shared/tailwind";
import { InteractiveGridPattern } from "../react/catalogo/InteractiveGridPattern";

import { CatalogoSection } from "../react/catalogo/CatalogoSection";
import { HeroProvider } from "../react/catalogo/Provider";

const { currentLocale } = Astro;
const i18n_catalog = getI18NCatalog({ currentLocale });

const t_catalog = (key: string) => getValueFromKey(key, i18n_catalog);
---

<div class="flex">
  <InteractiveGridPattern
    client:only
    className={cn(
      "[mask-image:radial-gradient(400px_circle_at_center,white,transparent)] -mt-40"
    )}
    width={20}
    height={20}
    squares={[80, 80]}
    squaresClassName="hover:fill-interbrasGreen-500"
  />

  <div class="flex-1 justify-center items-end pr-20 flex-col hidden lg:flex">
    <img
      src="/1.png"
      alt="recopilacion de productos"
      class="h-[500px] object-contain -rotate-12 scale-90 fade"
    />
  </div>
  <div
    class="flex justify-center items-center flex-col h-[500px] my-9 gap-5 pointer-events-none relative z-20 mx-auto"
  >
    <div class="flex flex-col items-center gap-4 mx-auto">
      <h1 class="text-5xl font-bold text-center" id="catalogTitle" data-lang={currentLocale}>
        {t_catalog("title")}
      </h1>

      <h2 class="text-xl text-center">
        {t_catalog("subtitle")}
      </h2>
    </div>

    <button
      class="bg-interbrasGreen-500 hover:bg-interbrasGreen-600 text-white px-5 py-2 rounded-xl text-xl flex gap-3 pointer-events-auto"
      id="downloadCatalog"
    >
      {t_catalog("download")}
      <svg
        class="w-auto h-6 my-auto fill-white"
        clip-rule="evenodd"
        fill-rule="evenodd"
        stroke-linejoin="round"
        stroke-miterlimit="2"
        viewBox="0 0 267 267"
        xmlns="http://www.w3.org/2000/svg"
        id="fi_12262500"
        ><g transform="matrix(4.167 0 0 4.167 -666.667 0)"
          ><path
            d="m213 53h-42v-8c0-.552-.448-1-1-1h-6c-.552 0-1 .448-1 1v10.492c0 3.042 2.466 5.508 5.508 5.508h46.984c3.042 0 5.508-2.466 5.508-5.508 0-4.418 0-10.492 0-10.492 0-.552-.448-1-1-1h-6c-.552 0-1 .448-1 1zm-28-27h-13c-.4 0-.762.238-.919.606-.158.368-.081.794.195 1.084l20 21c.189.198.45.31.724.31s.535-.112.724-.31l20-21c.276-.29.353-.716.195-1.084-.157-.368-.519-.606-.919-.606h-13v-22c0-.552-.448-1-1-1h-12c-.552 0-1 .448-1 1z"
          ></path></g
        ></svg
      >
    </button>
    <button
      class="bg-interbrasGreen-500 hover:bg-interbrasGreen-600 text-white px-5 py-2 rounded-xl text-xl flex gap-3 pointer-events-auto"
      id="downloadImages"
    >
      Descargar como fotos
      <svg class="w-auto h-6 my-auto fill-white" viewBox="0 0 24 24">
        <path d="M12 16l4-5h-3V4h-2v7H8z"/><path d="M20 18H4v-2H2v4h20v-4h-2z"/>
      </svg>
    </button>

    <button
      class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-xl text-xl flex gap-3 pointer-events-auto"
      id="downloadA4"
    >
      Exportar como A4
      <svg class="w-auto h-6 my-auto fill-white" viewBox="0 0 24 24">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
      </svg>
    </button>

  </div>

  <div class="flex-1 justify-center items-start pr-20 flex-col hidden lg:flex">
    <img
      src="/2.png"
      alt="recopilacion de productos"
      class="h-[500px] object-contain rotate-12 scale-90 fade"
    />
  </div>
</div>

<HeroProvider client:only>
  <CatalogoSection client:only currentLocale={currentLocale || "es"} />
</HeroProvider>

<div
  id="loader"
  class="fixed inset-0 bg-gradient-to-br from-black/95 via-black/90 to-black/95 backdrop-blur-sm justify-center items-center z-50 hidden"
>
  <div class="bg-white/10 backdrop-blur-md rounded-3xl p-8 md:p-12 shadow-2xl border border-white/20 max-w-md w-full mx-4 loader-card">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="size-12 border-4 border-interbrasGreen-500/30 rounded-full"></div>
          <div class="absolute inset-0 size-12 border-4 border-interbrasGreen-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <div>
          <p class="text-2xl font-bold text-white" id="loaderTitle">Generando PDF</p>
          <p class="text-sm text-gray-300" id="loaderSubtitle">Por favor espera...</p>
        </div>
      </div>
    </div>

    <!-- Barra de progreso -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-300">Progreso</span>
        <span class="text-sm font-bold text-white">
          <span id="currentPage">0</span>/<span id="totalPages">0</span>
        </span>
      </div>
      <div class="w-full h-3 bg-white/10 rounded-full overflow-hidden shadow-inner">
        <div 
          id="progressBar" 
          class="h-full bg-gradient-to-r from-interbrasGreen-500 to-interbrasGreen-400 transition-all duration-300 ease-out rounded-full shadow-lg"
          style="width: 0%"
        ></div>
      </div>
      <p class="text-xs text-gray-400 mt-2" id="progressPercentage">0%</p>
    </div>

    <!-- Información adicional -->
    <div class="bg-black/20 rounded-xl p-4 mb-6 border border-white/10">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-interbrasGreen-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        <p class="text-sm text-gray-300 leading-relaxed">
          Estamos procesando cada página de tu catálogo. Este proceso puede tardar unos momentos.
        </p>
      </div>
    </div>

    <!-- Botón de cancelar -->
    <button
      id="cancelButton"
      class="w-full bg-red-500/90 hover:bg-red-500 text-white px-6 py-3.5 rounded-xl text-base font-semibold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98]"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Cancelar generación
    </button>
  </div>
</div>

<!-- Toast de notificación -->
<div
  id="toast"
  class="fixed top-6 right-6 bg-white rounded-2xl shadow-2xl p-4 z-[60] transform translate-x-[120%] transition-transform duration-300 max-w-sm border-l-4"
>
  <div class="flex items-start gap-3">
    <div id="toastIcon" class="flex-shrink-0 mt-0.5"></div>
    <div class="flex-1">
      <p id="toastTitle" class="font-bold text-gray-900 text-sm mb-1"></p>
      <p id="toastMessage" class="text-gray-600 text-sm"></p>
    </div>
    <button id="toastClose" class="text-gray-400 hover:text-gray-600 transition-colors">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
      </svg>
    </button>
  </div>
</div>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"
></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"
  integrity="sha512-z8IYLHO8bTgFqj+yrPyIJnzBDf7DDhWwiEsk4sY+Oe6J2M+WQequeGS7qioI5vT6rXgVRb4K1UVQC5ER7MKzKQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>

<script is:inline>
  const catalogTitle = document.getElementById("catalogTitle");
  const currentLocale = (catalogTitle.getAttribute("data-lang") || "es") === "es" ? "ESPAÑOL" : "PORTUGUES";

  let isCancelled = false;

  // Función para mostrar toast
  function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    // Iconos y colores según el tipo
    const styles = {
      success: {
        icon: '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
        border: 'border-green-500'
      },
      error: {
        icon: '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
        border: 'border-red-500'
      },
      warning: {
        icon: '<svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
        border: 'border-yellow-500'
      }
    };
    
    const style = styles[type] || styles.success;
    toastIcon.innerHTML = style.icon;
    toast.className = `fixed top-6 right-6 bg-white rounded-2xl shadow-2xl p-4 z-[60] transition-transform duration-300 max-w-sm border-l-4 ${style.border}`;
    
    // Mostrar toast
    setTimeout(() => toast.style.transform = 'translateX(0)', 10);
    
    // Ocultar después de 4 segundos
    setTimeout(() => toast.style.transform = 'translateX(120%)', 4000);
  }

  // Cerrar toast manualmente
  document.getElementById('toastClose').addEventListener('click', () => {
    document.getElementById('toast').style.transform = 'translateX(120%)';
  });

  // Función para actualizar progreso
  function updateProgress(current, total, title = 'Generando PDF', subtitle = 'Por favor espera...') {
    const percentage = Math.round((current / total) * 100);
    document.getElementById('currentPage').textContent = current;
    document.getElementById('totalPages').textContent = total;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressPercentage').textContent = percentage + '%';
    document.getElementById('loaderTitle').textContent = title;
    document.getElementById('loaderSubtitle').textContent = subtitle;
  }

  // Función para mostrar/ocultar loader
  function toggleLoader(show) {
    const loader = document.getElementById('loader');
    if (show) {
      loader.classList.remove('hidden');
      loader.classList.add('flex');
    } else {
      loader.classList.add('hidden');
      loader.classList.remove('flex');
    }
  }

  document.getElementById("cancelButton").addEventListener("click", () => {
    isCancelled = true;
  });

  document
    .getElementById("downloadCatalog")
    .addEventListener("click", convertir);

  async function convertir() {
    isCancelled = false;
    const catalog = document.getElementById("catalog");

    if (!catalog) {
      showToast('Error', 'No se ha encontrado el catálogo o no se ha cargado correctamente', 'error');
      return;
    }

    catalog.classList.remove("hidden");

    toggleLoader(true);
    updateProgress(0, 0, 'Generando PDF', 'Preparando catálogo...');

    const catalogSections = document.querySelectorAll("#catalogSection");
    const hiddenItems = document.querySelectorAll('[data-hide="true"]');
    const eyeIcons = document.querySelectorAll('[data-eye]');
    hiddenItems.forEach((el) => (el.style.display = 'none'));
    eyeIcons.forEach((el) => (el.style.display = 'none'));
    
    updateProgress(0, catalogSections.length, 'Generando PDF', 'Procesando páginas...');

    const { PDFDocument } = PDFLib;
    const pdfDoc = await PDFDocument.create();

    for (const section of catalogSections) {
      if (isCancelled) {
        hiddenItems.forEach((el) => (el.style.display = ''));
        eyeIcons.forEach((el) => (el.style.display = ''));
        toggleLoader(false);
        showToast('Cancelado', 'La generación del PDF ha sido cancelada', 'warning');
        return;
      }

      const node = section;
      const dataUrl = await htmlToImage.toPng(node, { pixelRatio: 2 });

      const img = new Image();
      img.src = dataUrl;

      await new Promise((resolve) => {
        img.onload = async function () {
          const page = pdfDoc.addPage([img.width, img.height]);
          const pngImageBytes = await fetch(dataUrl).then((res) =>
            res.arrayBuffer()
          );
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          page.drawImage(pngImage, {
            x: 0,
            y: 0,
            width: img.width,
            height: img.height,
          });
          updateProgress(pdfDoc.getPageCount(), catalogSections.length, 'Generando PDF', 'Procesando páginas...');
          resolve(); // Esto asegura que el bucle espere a que `onload` termine
        };
      });
    }

    hiddenItems.forEach((el) => (el.style.display = ''));
    eyeIcons.forEach((el) => (el.style.display = ''));

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);

    const date = new Date();
    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();

    link.download = `Catalogo Interbras - ${currentLocale} - ${day}-${month}-${year}.pdf`;

    link.click();

    toggleLoader(false);
    showToast('¡Completado!', 'El PDF se ha descargado correctamente', 'success');
  }
</script>

<script is:inline>
  document
    .getElementById("downloadImages")
    .addEventListener("click", exportarComoFotos);

  async function exportarComoFotos() {
    isCancelled = false;
    const catalogSections = document.querySelectorAll("#catalogSection");

    if (!catalogSections.length) {
      showToast('Error', 'No se ha encontrado el catálogo', 'error');
      return;
    }

    toggleLoader(true);
    updateProgress(0, catalogSections.length, 'Generando imágenes', 'Preparando exportación...');

    const hiddenItems = document.querySelectorAll('[data-hide="true"]');
    const eyeIcons = document.querySelectorAll('[data-eye]');
    hiddenItems.forEach((el) => (el.style.display = 'none'));
    eyeIcons.forEach((el) => (el.style.display = 'none'));

    const zip = new JSZip();

    let index = 1;
    for (const section of catalogSections) {
      if (isCancelled) {
        hiddenItems.forEach((el) => (el.style.display = ''));
        eyeIcons.forEach((el) => (el.style.display = ''));
        toggleLoader(false);
        showToast('Cancelado', 'La generación de imágenes ha sido cancelada', 'warning');
        return;
      }

      const node = section;
      const dataUrl = await htmlToImage.toPng(node, { pixelRatio: 2 });
      const imgBlob = await (await fetch(dataUrl)).blob();

      zip.file(`catalogo-foto-${index.toString().padStart(2, "0")}.png`, imgBlob);
      updateProgress(index, catalogSections.length, 'Generando imágenes', 'Convirtiendo páginas...');
      index++;
    }

    hiddenItems.forEach((el) => (el.style.display = ''));
    eyeIcons.forEach((el) => (el.style.display = ''));

    const zipBlob = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement("a");
    const date = new Date();
    a.href = url;
    a.download = `Catalogo_Interbras_Imagenes_${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}.zip`;
    a.click();

    toggleLoader(false);
    showToast('¡Completado!', 'Las imágenes se han descargado correctamente', 'success');
  }
</script>

<script is:inline>
  document
    .getElementById("downloadA4")
    .addEventListener("click", exportarComoA4);

  async function exportarComoA4() {
    isCancelled = false;
    const catalogSections = document.querySelectorAll("#catalogSection");

    if (!catalogSections.length) {
      showToast('Error', 'No se ha encontrado el catálogo', 'error');
      return;
    }

    toggleLoader(true);
    updateProgress(0, catalogSections.length, 'Exportando A4', 'Preparando formato A4...');
    const hiddenItems = document.querySelectorAll('[data-hide="true"]');
    const eyeIcons = document.querySelectorAll('[data-eye]');
    hiddenItems.forEach((el) => (el.style.display = 'none'));
    eyeIcons.forEach((el) => (el.style.display = 'none'));

    // Configuraciones A4 en píxeles (300 DPI)
    const A4_WIDTH = 2480;
    const A4_HEIGHT = 3508;
    const MARGIN = 80;
    const AVAILABLE_WIDTH = A4_WIDTH - (MARGIN * 2);
    const AVAILABLE_HEIGHT = A4_HEIGHT - (MARGIN * 2);
    
    // Ancho fijo para todas las imágenes (90% del ancho disponible)
    const FIXED_WIDTH = AVAILABLE_WIDTH * 0.9;

    const { PDFDocument } = PDFLib;
    const pdfDoc = await PDFDocument.create();

    // Preparar todas las imágenes primero para calcular alturas
    const imageData = [];
    let processedImages = 0;

    for (const section of catalogSections) {
      if (isCancelled) {
        hiddenItems.forEach((el) => (el.style.display = ''));
        eyeIcons.forEach((el) => (el.style.display = ''));
        toggleLoader(false);
        showToast('Cancelado', 'La exportación A4 ha sido cancelada', 'warning');
        return;
      }

      const dataUrl = await htmlToImage.toPng(section, { pixelRatio: 2 });
      const img = new Image();
      img.src = dataUrl;

      await new Promise((resolve) => {
        img.onload = function () {
          processedImages++;
          updateProgress(processedImages, catalogSections.length, 'Exportando A4', 'Procesando imágenes...');
          
          const aspectRatio = img.width / img.height;
          // Calcular altura basada en el ancho fijo
          const calculatedHeight = FIXED_WIDTH / aspectRatio;
          
          imageData.push({
            dataUrl,
            originalWidth: img.width,
            originalHeight: img.height,
            aspectRatio,
            scaledWidth: FIXED_WIDTH,
            scaledHeight: calculatedHeight
          });
          
          resolve();
        };
      });
    }

    // Organizar imágenes en páginas A4
    let currentA4Page = null;
    let currentY = MARGIN;

    updateProgress(0, imageData.length, 'Exportando A4', 'Organizando páginas...');

    for (let i = 0; i < imageData.length; i++) {
      if (isCancelled) {
        hiddenItems.forEach((el) => (el.style.display = ''));
        eyeIcons.forEach((el) => (el.style.display = ''));
        toggleLoader(false);
        showToast('Cancelado', 'La exportación A4 ha sido cancelada', 'warning');
        return;
      }

      const image = imageData[i];
      const imageHeight = image.scaledHeight;
      const spacing = 40; // Espacio entre imágenes

      // Verificar si la imagen cabe en la página actual
      if (!currentA4Page || currentY + imageHeight + spacing > A4_HEIGHT - MARGIN) {
        // Crear nueva página
        currentA4Page = pdfDoc.addPage([A4_WIDTH, A4_HEIGHT]);
        currentY = MARGIN;
      }

      // Agregar imagen centrada horizontalmente
      const pngImageBytes = await fetch(image.dataUrl).then(res => res.arrayBuffer());
      const pngImage = await pdfDoc.embedPng(pngImageBytes);
      
      const x = (A4_WIDTH - FIXED_WIDTH) / 2; // Centrar horizontalmente
      
      currentA4Page.drawImage(pngImage, {
        x: x,
        y: A4_HEIGHT - currentY - imageHeight, // PDF coordenadas desde abajo
        width: FIXED_WIDTH,
        height: imageHeight,
      });

      currentY += imageHeight + spacing;
      updateProgress(i + 1, imageData.length, 'Exportando A4', 'Organizando páginas...');
    }

    hiddenItems.forEach((el) => (el.style.display = ''));
    eyeIcons.forEach((el) => (el.style.display = ''));

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);

    const date = new Date();
    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();
    const catalogTitle = document.getElementById("catalogTitle");
    const currentLocale = (catalogTitle.getAttribute("data-lang") || "es") === "es" ? "ESPAÑOL" : "PORTUGUES";

    link.download = `Catalogo_Interbras_A4_${currentLocale}_${day}-${month}-${year}.pdf`;
    link.click();

    toggleLoader(false);
    showToast('¡Completado!', 'El PDF A4 se ha descargado correctamente', 'success');
  }
</script>


<style is:global>
  .fade {
    opacity: 0;
    animation: fadeIn .3s forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
      transform: translate(0);
    }
  }

  .loader-card {
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  #progressBar {
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
  }

  #loader.hidden {
    display: none !important;
  }
</style>
